# GraphQL Implementation Summary

## Overview

This project now uses the **Verisure/Securitas Direct GraphQL API** instead of REST endpoints. The implementation is based on the official API used by the Verisure mobile app.

## GraphQL Endpoint

```
https://customers.verisure.co.uk/owa-api/graphql
```

(URL varies by country - see `src/lib/constants.ts`)

## Key Changes

### 1. GraphQL Operations

All API calls now use GraphQL mutations and queries:

**Login (Mutation):**
```typescript
{
  operationName: "mkLoginToken",
  variables: {
    user: "admin",
    password: "test",
    id: "OWA_______________admin_______________20260102011000",
    country: "GB",
    lang: "en",
    callby: "OWA_10",
    idDevice: "dummydeviceid1234",
    idDeviceIndigitall: "dummyindigitallid5678",
    deviceType: "",
    deviceVersion: "10.102.0",
    deviceResolution: "",
    deviceName: "PostmanTestClient",
    deviceBrand: "generic",
    deviceOsVersion: "12",
    uuid: "0000000000000000"
  },
  query: "mutation mkLoginToken(...) { ... }"
}
```

**Response:**
```typescript
{
  data: {
    xSLoginToken: {
      __typename: "...",
      res: "OK",
      msg: "...",
      hash: "JWT_TOKEN_HERE",
      refreshToken: "...",
      legals: "...",
      changePassword: false,
      needDeviceAuthorization: false,
      mainUser: "..."
    }
  }
}
```

### 2. Device Fingerprinting

The API requires device information for authentication:
- `deviceId` - Unique device identifier
- `uuid` - Device UUID
- `idDeviceIndigitall` - Indigitall push notification ID
- `deviceBrand`, `deviceName`, `deviceOsVersion`, etc.

These are automatically generated by the utility functions in `src/lib/utils.ts`.

### 3. Authentication Headers

GraphQL requests include special headers:
- `X-APOLLO-OPERATION-NAME` - The operation being executed
- `auth` - JSON stringified authentication object with hash, timestamp, etc.

### 4. Type Safety

All GraphQL operations have corresponding TypeScript interfaces:
- `LoginTokenResponse` - Login mutation response
- `InstallationListResponse` - Installation list query response
- `StatusResponse` - Alarm status query response
- `ArmDisarmResponse` - Arm/disarm mutation responses

## Implemented Operations

### Mutations
1. **mkLoginToken** - User authentication
2. **xSArmPanel** - Arm the alarm system
3. **xSDisarmPanel** - Disarm the alarm system

### Queries
1. **mkInstallationList** - List all installations
2. **Status** - Get current alarm status

## Testing

You can test the GraphQL API using the example file:

```bash
npm run build
node dist/example-graphql.js
```

Or use the CLI:

```bash
npm run dev
```

## GraphQL Request Format

All requests are POST to the GraphQL endpoint with:

```json
{
  "operationName": "operationName",
  "variables": { ... },
  "query": "query/mutation string"
}
```

## Reference Implementation

This implementation is based on:
- [guerrerotook/securitas-direct-new-api](https://github.com/guerrerotook/securitas-direct-new-api) - Python implementation analyzing the official app

## Future Enhancements

Potential GraphQL operations to implement:
- Device listing (xSDevices)
- Event history (xSEvents)
- Sentinel/sensors data (xSComfort)
- Smart lock control (xSChangeSmartlockMode)
- Air quality data (xSAirQ)

See the reference repository for more GraphQL query examples.
